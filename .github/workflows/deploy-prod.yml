name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy (e.g. v2026.02.04.1705)'
        required: true

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build

      - name: Extract artifact
        run: |
          tar -xzf app-*.tar.gz

      - name: Deploy release to PROD
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          RELEASE_VERSION: ${{ inputs.release_version }}
        run: |
          echo "$PROD_SSH_KEY" > prod_key.pem
          chmod 600 prod_key.pem

          ssh -i prod_key.pem -o StrictHostKeyChecking=no $PROD_USER@$PROD_HOST << EOF
            set -e

            BASE_DIR=/var/www/app
            RELEASE_DIR=\$BASE_DIR/releases/$RELEASE_VERSION

            mkdir -p \$RELEASE_DIR

            if [ ! -d "\$BASE_DIR/venv/bin" ]; then
              python3 -m venv \$BASE_DIR/venv
            fi
          EOF

          rsync -avz \
            -e "ssh -i prod_key.pem -o StrictHostKeyChecking=no" \
            app/ $PROD_USER@$PROD_HOST:/var/www/app/releases/$RELEASE_VERSION/

          ssh -i prod_key.pem -o StrictHostKeyChecking=no $PROD_USER@$PROD_HOST << EOF
            set -e

            BASE_DIR=/var/www/app
            RELEASE_DIR=\$BASE_DIR/releases/$RELEASE_VERSION

            \$BASE_DIR/venv/bin/pip install -r \$RELEASE_DIR/sample-app/requirements.txt

            if [ -L "\$BASE_DIR/current" ]; then
              ln -sfn \$(readlink \$BASE_DIR/current) \$BASE_DIR/previous
            fi

            ln -sfn \$RELEASE_DIR \$BASE_DIR/current

            sudo systemctl restart app
          EOF

      - name: Health check
        run: |
          sleep 5
          curl -f http://${{ secrets.PROD_HOST }}:8080

